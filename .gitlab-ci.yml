# The configuration file for the GitLab CI/CD pipeline. 

# Variables that can be reused across the CI/CD pipeline scripts.
variables:
  # The relative path to the 'requirements.txt' file 
  # which lists all Python dependencies necessary for the project.
  REQUIREMENTS_PATH: "./config/requirements.txt"

  # The relative path to the 'mkdocs.yml' file, 
  # the configuration file for the MkDocs documentation generator.
  MKDOCS_CONFIG_PATH: "./config/mkdocs.yml"

  # The relative path to the 'public' directory. 
  # The 'public' directory is where the static website generated by MkDocs will be placed.
  PUBLIC_PATH: "public"

  # The relative path to the static data directory. 
  # This directory contains static data to be included in the final documentation website.
  CONFIG_STATIC_PATH: "config/static/*"

  # The relative or absolute path to the directory containing the documentation source files.
  DOCS_PATH: "./wiki"

  # The prefix used to identify directories that should be excluded from the documentation build.
  EXCLUDE_PREFIX: "~"

  # Python path for custom global scripts
  PYTHONPATH: "."

# The Docker image to be used for the CI/CD pipeline. 
# This image comes pre-installed with PlantUML and Poetry, 
# necessary tools for the documentation generation process.
image: dstockhammer/plantuml-poetry:latest

# Definition of the job that will be executed in the 'deploy' stage of the CI/CD pipeline.
pages:
  # The name of the stage in which this job will run. 
  # The 'deploy' stage typically comes after all 'build' and 'test' stages have successfully completed.
  stage: deploy

  script:
    # Installs all Python dependencies listed in the 'requirements.txt' file.
    - pip install -r $REQUIREMENTS_PATH

    # Run preprocessing script to exclude certain folders
    - python ./config/hide_sensitive_files.py

    # Executes the MkDocs build process. 
    # --strict: The build process will fail on any warnings.
    # --verbose: Enables detailed output during the build process.
    - mkdocs build --strict --verbose --config-file $MKDOCS_CONFIG_PATH

    # Moves all static data from the 'config/static' directory to the 'public' directory.
    - mv $CONFIG_STATIC_PATH $PUBLIC_PATH/

  # Defines the artifacts for this job. 
  # Artifacts are the output files that will be kept after the job has run.
  artifacts:
    paths:
      # The 'public' directory, containing the generated website, is kept as an artifact.
      - $PUBLIC_PATH

  # Specifies the conditions under which the job should be run.
  only:
    # The job will only be run when changes are made to the 'main' branch. 
    # This ensures the documentation site is updated only when 'main' is updated.
    - main
